<!DOCTYPE html> <!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]--> <!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]--> <!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]--> <head> <meta charset="utf-8"> <title>@Lenciel</title> <meta name="author" content="Lenciel"> <meta name="description" content=" 马尔克斯的孤独与爱 2014-04-18 20:58:42 ..."> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="canonical" href="http://lenciel.com/posts/41/"> <link href="/favicon.png" rel="icon"> <script src="/assets/javascripts/app.js"></script> <link href="http://feeds.feedburner.com/github/lenciel" rel="alternate" title="@Lenciel" type="application/atom+xml"> <meta property="og:type" content="article"/> <meta property="og:url" content="http://lenciel.com/posts/41/"/> <meta property="og:description" content=" 马尔克斯的孤独与爱 2014-04-18 20:58:42 ..."/> <meta property="og:site_name" content="http://lenciel.com"/> <meta property="article:author" content="http://lenciel.com"> <meta itemprop="description" content=" 马尔克斯的孤独与爱 2014-04-18 20:58:42 ..."/> <script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?42345b94bf173b38bef61f873677adfa";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','http://lenciel.qiniudn.com/analytics.js','ga');

  ga('create', 'UA-175991-6', 'auto');
  ga('send', 'pageview');

</script> </head> <body class="collapse-sidebar sidebar-footer"> <header role="banner"><hgroup> <h1><a href="/">@Lenciel</a></h1> </hgroup> </header> <nav role="navigation"><ul class="subscription" data-subscription="rss"> <li><a href="http://feeds.feedburner.com/github/lenciel" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li> </ul> <ul class="main-navigation"> <li><a href="/"><i class="icon-home"></i>Home</a></li> <li><a href="/archives"><i class="icon-book-alt"></i>Archives</a><span class="divider"></span></li> <li><a href="/about"><i class="icon-user"></i>About</a><span class="divider"></span></li> </ul> </nav> <div id="main"> <div id="content"> <div class="blog-index"> <article> <header> <h1 class="entry-title"><a href="/2014/04/rip-marquez/">马尔克斯的孤独与爱</a></h1> <p class="meta"> <time class='entry-date' datetime='2014-04-18 20:58:42 +0800'> <span class='date'>2014-04-18</span> <span class='time'>20:58:42</span> </time> </p> </header> <div class="entry-content"><p><img src="/downloads/images/2014_04/rip_marquez.jpg" title="Don't touch me..." alt="Vhost threshold"/></p> <p>度过了忙乱的一周，又回到了广汉。吃完饭洗个澡，继续在书房干活，外面的天不知不觉就黯淡下来。偶像派走过来说，《舌尖上的中国》第二季开播了，快来看吧。</p> <p>但我总觉得有什么没有做，合上电脑之前，突然想起来，对，是马尔克斯没了。早上听到这个消息的时候，我好像想着要说点儿什么来着的。</p> <p>我最喜欢的作家是马尔克斯，但我一般不会推荐别人去读他的小说。有人问我谁的小说比较好看时，我一般都推荐村上春树。</p> <p>在我看来，什么是好的小说呢？像《白鹿原》、《平凡的世界》那些当然是非常好的小说，但这些小说你读起来更多是在领略，而不是在参与。换句话说，那些是适合十几岁的时候看的东西。</p> <p>而活到一定年纪，你就会发现，人生就像在爬山，因为路太窄，加上不是在上坡，就是在下坡，很难在你想策马奔腾的时候就能找到一块平坦的地方，让你潇洒一番：大多数时候你不过是孤孤单单地走在爬山的路上而已。</p> <p>问我的人大都和我差不多年纪，在城市里面生活，我想他们的体会应该和我类似。而在我眼中，村上春树把城市生活里的孤独感捕捉并表达到了无论是什么背景的读者都会有所共鸣的地步，所以我推荐他的小说。</p> <p>但村上的小说，虽然我非常喜欢，为什么只能排在马尔克斯后面呢？大概和他有些<a href="http://www.xnuts.cn/marathon_cross-country-race/1886.html">刻板的写作生活有关</a>，村上的作品会让你感觉到从孤独到弃绝的意味。换句话说，你经常能被他营造的孤独感吞没，他却没有告诉你应该怎么办：他自己呢，倒是知道避开作家圈子，知道去听歌跑步健身，知道在鸡蛋和高墙之间如何选择。</p> <p>而马尔克斯则大不相同。在很多时候，他被书商打上了孤独者的标签贩卖（在我们这个年代，孤独者的孤独也成了时髦，真是让孤独者无处可逃啊）。他下面这段话，也随着《百年孤独》在国内广为传颂：</p> <blockquote><p>过去都是假的，回忆是一条没有归途的路，以往的一切春天都无法复原，即使最狂乱且坚韧的爱情，归根结底也不过是一种瞬息即逝的现实，唯有孤独永恒。</p></blockquote> <p>但看过《百年孤独》的人都知道，那其实是个非常热闹的故事。换句话说，虽然是写出了前面这段带着些孤独宿命论的话，马尔克斯并不是仅仅靠营造孤独感来引起你共鸣：他在劝你好好去爱。</p> <p>孤独的确是人的宿命：我们每个人都是这世界上一个偶然的存在，生命如此漫长又短暂，我们一直在得到和失去，汲取和忘却，不要说别人，我们自己也不一定来得及了解自己。</p> <p>很多人以为对抗孤独，需要绝对的爱，比如男女之间那种想要燃尽各自的肉体和精神的完全排他性的爱，或者父母孩子之间那种完全忘我不计付出的爱。</p> <p>但无论村上还是马尔克斯讲诉的故事，都告诉你即便是这些绝对的爱，也难以与岁月相抗衡。人们对此心知肚明，可是往往还是憧憬着绝对的爱，对自己所拥有的“有瑕疵的爱”感到不满足。</p> <p>于是马尔克斯更进一步，他告诉你那份孤独恰恰是爱的最意味深长的赠品。你接受了这份赠品，就能学会理解别的孤独的灵魂和深藏于它们之中的深邃的爱。读懂他你会明白，是否一起生活一起死去并不重要，能够在他/她到来的时候好好去爱，其充实感是任何体验都无法比拟的。从某种意义上说，那么强烈的感情正是人的一生中最美好的东西。</p> <p>所以，并没有像电池一样的东西在持续供给着让你对抗孤独。那些某个瞬间点燃的火花，就足够照亮我们漫长的日常生活。</p> </div> </article> <article> <header> <h1 class="entry-title"><a href="/2014/04/openssl-heartbleed-bug/">Openssl Heartbleed Bug</a></h1> <p class="meta"> <time class='entry-date' datetime='2014-04-10 11:29:15 +0800'> <span class='date'>2014-04-10</span> <span class='time'>11:29:15</span> </time> </p> </header> <div class="entry-content"><p>连某宝都中招的<a href="http://heartbleed.com/">Heartbleed bug</a>究竟是个什么东西？简单地说就是攻击者可以读最多64KB内存的内容。</p> <p>读了这64KB能干嘛？用报这个bug的人的话来说：</p> <blockquote><p>Without using any privileged information or credentials we were able steal from ourselves the secret keys used for our X.509 certificates, user names and passwords, instant messages, emails and business critical documents and communication.</p></blockquote> <p>那么读取64KB内存和获取这么多关键信息究竟有什么关系呢？</p> <a name="The.bug"></a> <h2>The bug</h2> <p>先来看看<a href="http://git.openssl.org/gitweb/?p=openssl.git;a=commitdiff;h=96db9023b881d7cd9f379b0c154650d6c108e9a3">patch</a>里面的<code>ssl/d1_both.c</code>:</p> <pre><code class="c">int            
dtls1_process_heartbeat(SSL *s)
    {          
    unsigned char *p = &amp;s-&gt;s3-&gt;rrec.data[0], *pl;
    unsigned short hbtype;
    unsigned int payload;
    unsigned int padding = 16; /* Use minimum padding */
</code></pre> <p>可以看到，heartbeat里有一个 <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">SSLv3</a> record的指针，这个<code>record</code>的代码如下:</p> <pre><code class="c">typedef struct ssl3_record_st
    {
        int type;               /* type of record */
        unsigned int length;    /* How many bytes available */
        unsigned int off;       /* read/write offset into 'buf' */
        unsigned char *data;    /* pointer to the record data */
        unsigned char *input;   /* where the decode bytes are */
        unsigned char *comp;    /* only used with decompression - malloc()ed */
        unsigned long epoch;    /* epoch number, needed by DTLS1 */
        unsigned char seq_num[8]; /* sequence number, needed by DTLS1 */
    } SSL3_RECORD;
</code></pre> <p>可以看到，每个<code>record</code>有它的<code>type</code>、<code>length</code>和<code>data</code>，规规矩矩。</p> <p>回到<code>dtls1_process_heartbeat</code>：</p> <pre><code class="c">/* Read type and payload length first */
hbtype = *p++;
n2s(p, payload);
pl = p;
</code></pre> <p>可以看到<code>SSLv3 record</code>的第一个byte就是放这个<code>heartbeat</code>的<code>type</code>。 宏<code>n2s</code> 则是从<code>p</code>里面取两个byte放到payload里面，被用来作为payload的长度。 <strong>注意这里并没有检查<code>SSLv3 record</code> 实际的长度。</strong></p> <p>接下来在这个函数里面干了下面这些事情：</p> <pre><code class="c">unsigned char *buffer, *bp;
int r;

/* Allocate memory for the response, size is 1 byte
 * message type, plus 2 bytes payload length, plus
 * payload, plus padding
 */
buffer = OPENSSL_malloc(1 + 2 + payload + padding);
bp = buffer;
</code></pre> <p>可以看到，用户要多少程序就分配多少，最多可以分配到<code>65535+1+2+16</code>，指针bp被用来操作这块内存。然后：</p> <pre><code class="c">/* Enter response type, length and copy payload */
*bp++ = TLS1_HB_RESPONSE;
s2n(payload, bp);
memcpy(bp, pl, payload);
</code></pre> <p>宏<code>s2n</code>把<code>n2s</code>做的操作恢复出来：先拿16个bit的值放到2个byte里面，也就是原来请求的payload的长度。然后把<code>pl</code>里面放的payload(请求者提交的data)拷贝到新分配的<code>bp</code>里面。</p> <p>看起来是很平常的操作，只不过没有认真的检查用户输入而已，但问题也就在这里了。</p> <a name="Where.is.the.bug"></a> <h2>Where is the bug</h2> <p>如果用户并没有正在提交声称的那么多个bytes的payload，那么memcpy就会读到同一个process里面SSLv3 record附近的内存内容。</p> <p>这附近有哪些内容呢？</p> <p>首先要明白在linux上，内存的动态分配主要是通过<a href="http://linux.die.net/man/2/sbrk">sbrk</a> 或者是 <a href="http://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a>。如果内存是通过sbrk分配的，它会使用<code>heap-grows-up</code>规则，泄露出来的东西不会那么多（但是如果是同时并发请求<a href="http://blog.existentialize.com/diagnosis-of-the-openssl-heartbleed-bug.html#fn:update">还是有东西会漏</a>）。</p> <p>在这里，<code>pl</code>因为malloc里面的mmap_threshhold多半是sbrk分配的，但是，那些关键的用户数据，则多半是通过mmap分配内存。于是这些数据就会被攻击者用<code>pl</code>拿到。如果再考虑并发请求，就&hellip;</p> <a name="The.fix"></a> <h2>The fix</h2> <p>所以，整个patch里面最主要的fix就是： * 检查是否有长度为0的虚假heartbeat * 检查record的真实长度</p> <p>代码如下：</p> <pre><code class="c    ">    /* Read type and payload length first */
    if (1 + 2 + 16 &gt; s-&gt;s3-&gt;rrec.length)
        return 0; /* silently discard */
    hbtype = *p++;
    n2s(p, payload);
    if (1 + 2 + payload + 16 &gt; s-&gt;s3-&gt;rrec.length)
        return 0; /* silently discard per RFC 6520 sec. 4 */
    pl = p;
</code></pre> <a name="So."></a> <h2>So?</h2> <p>这个bug大概算是影响这么剧烈的bug里面最好明白的一个，所以居然我也看明白了。感受：</p> <ul> <li>为了可扩展性引入了复杂度，经常都会带来恶梦</li> <li>用户的输入，无论如何都不能相信，一定要check</li> <li>C语言的确是大牛小牛都会踩到坑啊</li> </ul> </div> </article> <div class="pagination"> <a class="prev" href="/posts/42">&larr; Older</a> <a href="/archives">Archives</a> <a class="next" href="/posts/40">Newer &rarr;</a> </div> </div> </div> </div> <footer role="contentinfo"><p> Blog theme: <a href="https://github.com/lenciel/jekyll-lenciel-theme">jekyll-lenciel-theme</a> <span class="theme-version">Copyright &copy; 2004-2017 by <a href="mailto:lenciel@gmail.com">Lenciel</a></span> <section class="contruction-wrap"> <div class="contruction"></div> </section> </p> </footer> <script type="text/javascript">
  var stylesheet = document.createElement('link');
  stylesheet.href = '/assets/stylesheets/app.css';
  stylesheet.rel = 'stylesheet';
  stylesheet.type = 'text/css';
  document.getElementsByTagName('head')[0].appendChild(stylesheet);
</script> </body> </html>