<!DOCTYPE html> <!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]--> <!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]--> <!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]--> <head> <meta charset="utf-8"> <title>Data Migration in Django 1.7 (1) - @Lenciel</title> <meta name="author" content="Lenciel"> <meta name="description" content=" Data Migration in Django 1.7 (1) Django 1.7已经发布一段时间了，基本上这个版本最主要的改动就是加入了..."> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="canonical" href="http://lenciel.com/2014/08/django-1-dot-7-migrations/"> <link href="/favicon.png" rel="icon"> <script src="/assets/javascripts/app.js"></script> <link href="http://feeds.feedburner.com/github/lenciel" rel="alternate" title="@Lenciel" type="application/atom+xml"> <meta property="og:title" content="Data Migration in Django 1.7 (1)"/><meta itemprop="name" content="Data Migration in Django 1.7 (1)"/> <meta property="og:type" content="article"/> <meta property="og:url" content="http://lenciel.com/2014/08/django-1-dot-7-migrations/"/> <meta property="og:description" content=" Data Migration in Django 1.7 (1) Django 1.7已经发布一段时间了，基本上这个版本最主要的改动就是加入了..."/> <meta property="og:site_name" content="http://lenciel.com"/> <meta property="article:author" content="http://lenciel.com"> <meta property="article:published_time" content="2014-08-05 11:12:41 +0800"/> <meta property="article:section" content="djangotutorial"/> <meta itemprop="description" content=" Data Migration in Django 1.7 (1) Django 1.7已经发布一段时间了，基本上这个版本最主要的改动就是加入了..."/> <script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?42345b94bf173b38bef61f873677adfa";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','http://lenciel.qiniudn.com/analytics.js','ga');

  ga('create', 'UA-175991-6', 'auto');
  ga('send', 'pageview');

</script> </head> <body class="collapse-sidebar sidebar-footer"> <header role="banner"><hgroup> <h1><a href="/">@Lenciel</a></h1> </hgroup> </header> <nav role="navigation"><ul class="subscription" data-subscription="rss"> <li><a href="http://feeds.feedburner.com/github/lenciel" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li> </ul> <ul class="main-navigation"> <li><a href="/"><i class="icon-home"></i>Home</a></li> <li><a href="/archives"><i class="icon-book-alt"></i>Archives</a><span class="divider"></span></li> <li><a href="/about"><i class="icon-user"></i>About</a><span class="divider"></span></li> </ul> </nav> <div id="main"> <div id="content"> <div> <article class="hentry" role="article"> <header> <h1 class="entry-title">Data Migration in Django 1.7 (1)</h1> <p class="meta"> </p> </header> <div class="entry-content"><p>Django 1.7已经发布一段时间了，基本上这个版本最主要的改动就是加入了<code>migrations</code>。</p> <p>在过去，几乎所有的Django项目都是用South来处理数据变更的。而在Django1.7版本，South的作者Andrew Godwin把<code>migrations</code>加到了Django Core里面。</p> <p>So&hellip;</p> <a name="Migrations............"></a> <h1>Migrations是什么？</h1> <p>Migrations其实就是一堆帮助你完成数据库变更和数据迁移的命令，使得你可以用“Django”的方式来管理和变更数据库的schema。比如，当你的model改变了，你需要在数据库里面去重命名一列时，你不会想跑到命令行下面去敲SQL吧？特别是，如果你要变更的数据库是线上的，有几百万用户数据，你应该更不愿意搭上这种活了吧？</p> <p>Migrations让事情变得简单可控：</p> <ol> <li>它使得数据库schema的调整可以通过Django命令来完成</li> <li>它使得数据库的schema和对应的model的变更被track起来：整个历史都可以版本化在Git里面</li> <li>提供了一套匹配schema和对应的fixture的机制</li> <li>如何和CI搭配起来，可以保证代码和数据一致性</li> </ol> <a name="Migrations......"></a> <h1>Migrations上手</h1> <a name="L.................."></a> <h2>创建测试项目</h2> <p>首先创建一个virtualenv和django项目：</p> <pre><code class="bash">$ mkvirtualenv django17
$ pip install https://www.djangoproject.com/download/1.7c2/tarball/
$ django-admin.py startproject django_migration_test
$ cd django_migration_test
$ python manage.py startapp ts_data
</code></pre> <p>然后创建一个model到subl ts_data/models.py：</p> <pre><code class="python">from django.db import models

# Create your models here.
class PingPongPrice(models.Model):
    date = models.DateTimeField(auto_now_add=True)
    price = models.DecimalField(max_digits=5, decimal_places=2)
</code></pre> <p>subl django_migration_test/settings.py</p> <pre><code class="python">INSTALLED_APPS = (
    ...
    'ts_data',
)
</code></pre> <a name="L......Migrations"></a> <h2>创建Migrations</h2> <p>使用下面的命令可以创建ts_data这个app的Migrations。当然，和大多数Django命令一样，如果你不显式的指定，就</p> <pre><code>(django17) ○ python manage.py makemigrations ts_data
Migrations for 'ts_data':
  0001_initial.py:
    - Create model PingPongPrice
</code></pre> <a name="L......Migrations"></a> <h2>应用Migrations</h2> <pre><code class="bash">(django17) ○ python manage.py migrate
Operations to perform:
  Apply all migrations: admin, contenttypes, ts_data, auth, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying sessions.0001_initial... OK
  Applying ts_data.0001_initial... OK
</code></pre> <p>注意，因为是一个全新的app，这条命令会先建表，换句话说，之前版本的<code>syncdb</code>命令可以不用了。整个使用流程应该变成：</p> <ol> <li>建立或者更新一个model</li> <li>运行<code>python manage.py makemigrations &lt;app_name&gt;</code></li> <li>运行<code>python mange.py migrate &lt;app_name</code>来应用创建的Migrations</li> <li>重复前面的步骤</li> </ol> <a name="L................................."></a> <h1>不是新建的项目如何使用</h1> <p>大多数情况下我们都是从旧版本的Django迁移过来，也就意味着是从South迁移过来。这种情况下需要：</p> <ol> <li>删除所有的South创建的migration文件</li> <li>运行 <code>./manage.py makemigrations</code>，Django会根据你当前model来创建那份<code>initial migrations file</code></li> <li>运行<code>./manage.py migrate</code>，Django会把已经存在的数据库table当成是migration的产物，完成整个migration</li> </ol> <p>如果你运行上面的命令遇到错误，就需要运行 <code>./manage.py migrate --fake &lt;appname&gt;</code> 做一个fake的migration。</p> <p>如果你不想丢掉过去的South维护的历史记录，可以同时使用South和Django Migrations：升级South到1.0，然后<a href="http://www.aeracode.org/2014/7/1/end-era/">参考这篇文章的做法</a>。</p> <a name="South...Django.Migrations......"></a> <h1>South和Django Migrations比较</h1> <p>对比一下South和Django Migrations的workflow，可能会更加清晰：</p> <a name="L............migrations"></a> <h2>首次全新migrations</h2> <p>South:</p> <pre><code class="python">./manage.py syncdb
./manage.py schemamigration &lt;appname&gt; --initial
</code></pre> <p>Django Migrations:</p> <pre><code class="python">./manage.py makemigrations &lt;appname&gt;
</code></pre> <a name="L......migrations"></a> <h2>应用migrations</h2> <p>South:</p> <pre><code class="python">./manage.py migrate &lt;appname&gt;
</code></pre> <p>Django Migrations:</p> <pre><code class="python">./manage.py migrate &lt;appname&gt;
</code></pre> <a name="L.........migrations"></a> <h2>非首次migrations</h2> <p>South:</p> <pre><code class="python">./manage.py schemamigration &lt;appname&gt; --auto
</code></pre> <p>Django Migrations:</p> <pre><code class="python">./manage.py makemigration &lt;appname&gt;
</code></pre> <p>可以看到，大概是因为出自同一个作者的原因，Django Migrations基本上follow了South的工作流程，只不过是命令更加简洁和清晰了。</p> <a name="L............"></a> <h1>更多细节</h1> <a name="L..................Django.Migrations........."></a> <h2>哪些变化会被Django Migrations找到？</h2> <p>如果你再次运行<code>python manage.py migrate</code>，会发现什么都没有发生：这是因为在项目的数据库中有一张<code>django_migrations</code>仍然被更新。表，记录了哪些Migrations已经被应用过了：无论是运行了migrate还是fake的，这个表都会被插入一条记录。比如从South升级到使用Django自带的MigrationsDjango会检查是否有更新。如果没有，它就fake一次，但<code>django_migrations</code>仍然被更新。</p> <p>在少数情况下，确实有需要再次运行某个特定的Migrations，我们可以在<code>django_migrations</code>里面把这个记录删除掉。</p> <p>在极少数情况下，如果你有需要回退到特定的版本，比如最初的zero版本，可以用类似<code>python manage.py migrate &lt;app_name&gt; zero</code>的语法。</p> <a name="Migration......."></a> <h2>Migration 文件</h2> <p>在我们运行<code>python manage.py migrate &lt;app_name&gt;</code>究竟发生了什么？实际上，Django会创建一个python文件来描述如何完成这个migration，以前面的ts_data为例，这个文件位于<code>ts_data/migrations/0001_initial.py</code>，内容如下：</p> <pre><code class="python"># -*- coding: utf-8 -*-
from __future__ import unicode_literals

from django.db import models, migrations


class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='PingPongPrice',
            fields=[
                ('id', models.AutoField(verbose_name='ID', serialize=False, auto_created=True, primary_key=True)),
                ('date', models.DateTimeField(auto_now_add=True)),
                ('price', models.DecimalField(max_digits=5, decimal_places=2)),
            ],
            options={
            },
            bases=(models.Model,),
        ),
    ]
</code></pre> <p>可以看到，是完全可读的Python代码。这也是为什么推荐把整个<code>migrations</code>文件夹加入版本控制的原因：这样你的应用经过了怎样的变更就变得可以回溯了。</p> <a name="Migration.Dependencies"></a> <h2>Migration Dependencies</h2> <p>上面的源代码有一些值得注意的地方。</p> <p>首先，所有的migration file里面都有一个<code>Migration()</code>类，继承自<code>django.db.migrations.Migration</code>。在我们运行<code>migrate</code>命令的时候，运行的就是这个类。</p> <p>这个类有两个list，一个是<code>dependencies</code>，一个是<code>operations</code>。</p> <p><code>dependencies</code>定义了这个migration之前必须完成的操作，比如你的model里面包括一个外键，那么你得首先有对应的table。比如，假设外键指向的model在<code>app_1</code>，那么<code>dependencies</code>会像这样：</p> <pre><code class="python">dependencies = [
   ('main', '__first__'),
]
</code></pre> <p>如果没有前置条件，这个list可以为空。但大多数时候<code>dependencies</code>是指向其他的migration文件。比如：</p> <pre><code class="python">dependencies = [
    ('main', '0001_initial'),
]
</code></pre> <p>这里使用list的结果是，所有的依赖是没有顺序的，也就是说你不需要按照0001、0002、0003的顺序来排列所有的依赖。</p> <a name="Migration.Operations"></a> <h2>Migration Operations</h2> <p>这个list定义的就是migration完成的操作，可以分为下面的这些种类：</p> <ul> <li>CreateModel</li> <li>DeleteModel</li> <li>RenameModel</li> <li>AlterModelTable</li> <li>AlterUniqueTogether</li> <li>AlteIndexTogether</li> <li>AddField</li> <li>RemoveField</li> <li>RenameField</li> <li>RunSQL</li> <li>RunPython</li> </ul> <p>前面的那些操作是整个Django Migrations的核心：因为需要对各种不同的数据库做适配。而后面的两个操作则是灵活度非常高的，几乎可以干任何事情。</p> <a name="L......"></a> <h1>实例</h1> <p>让我们试试把<code>PingPongPrice</code>的<code>price</code>这个field的<code>max_digits</code>改成8位的（通货膨胀嘛），然后再次运<code>makemigrations</code>行命令:</p> <pre><code class="bash">(django17) ○ python manage.py makemigrations ts_data
Migrations for 'ts_data':
  0002_auto_20140805_1525.py:
    - Alter field price on PingPongPrice
</code></pre> <p>可以看到这次生成的migration文件里面有<code>AlterField</code>操作：</p> <pre><code class="python"># -*- coding: utf-8 -*-
from __future__ import unicode_literals

from django.db import models, migrations


class Migration(migrations.Migration):

    dependencies = [
        ('ts_data', '0001_initial'),
    ]

    operations = [
        migrations.AlterField(
            model_name='PingPongPrice',
            name='price',
            field=models.DecimalField(max_digits=8, decimal_places=2),
        ),
    ]
</code></pre> </div> <footer> <p class="meta"> <span class="byline author vcard">Posted by <span class="fn">Lenciel</span></span> <span class="categories"> <a class='category' href='/categories/django/'>django</a>, <a class='category' href='/categories/tutorial/'>tutorial</a> </span> </p> <div class="sharing"> </div> <p class="meta"> <a class="basic-alignment left" href="/2014/08/before-sunrise/" title="Previous Post: It's August now, boy...">&laquo; It's August now, boy...</a> <a class="basic-alignment right" href="/2014/08/how-to-beat-the-penguin/" title="Next Post: 如何不正确的殴打企鹅">如何不正确的殴打企鹅 &raquo;</a> </p> </footer> </article> </div> </div> </div> <footer role="contentinfo"><p> Blog theme: <a href="https://github.com/lenciel/jekyll-lenciel-theme">jekyll-lenciel-theme</a> <span class="theme-version">Copyright &copy; 2004-2017 by <a href="mailto:lenciel@gmail.com">Lenciel</a></span> <section class="contruction-wrap"> <div class="contruction"></div> </section> </p> </footer> <script type="text/javascript">
  var stylesheet = document.createElement('link');
  stylesheet.href = '/assets/stylesheets/app.css';
  stylesheet.rel = 'stylesheet';
  stylesheet.type = 'text/css';
  document.getElementsByTagName('head')[0].appendChild(stylesheet);
</script> </body> </html>